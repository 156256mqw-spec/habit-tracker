<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="习惯打卡">
    <meta name="mobile-web-app-capable" content="yes">
    <title>习惯打卡</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; }
        
        html, body {
            font-family: 'Noto Sans SC', sans-serif;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .habit-card { transition: all 0.3s ease; }
        .habit-card:active { transform: scale(0.98); }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }
        
        .calendar-day.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        
        .calendar-day.today {
            border: 2px solid #6366f1;
            font-weight: bold;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 448px;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        .main-content {
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti-fall 3s ease-out forwards;
            z-index: 9999;
            pointer-events: none;
        }
        
        .color-option.selected {
            transform: scale(1.2);
            box-shadow: 0 0 0 3px white, 0 0 0 5px currentColor;
        }
        
        .icon-option.selected {
            background: #6366f1;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="h-[100dvh] flex flex-col max-w-md mx-auto bg-white shadow-2xl relative overflow-hidden">
        
        <!-- Header -->
        <header class="glass sticky top-0 z-40 px-6 py-4 border-b border-gray-100 shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-indigo-600">习惯打卡</h1>
                    <p class="text-sm text-gray-500 mt-1" id="current-date">加载中...</p>
                </div>
                <button onclick="showAddModal()" class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg active:scale-95">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto main-content relative" id="main-content">
            
            <!-- Today View -->
            <div id="today-view" class="p-4 space-y-4">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-indigo-100 text-sm">今日完成度</p>
                            <h2 class="text-3xl font-bold mt-1" id="today-progress">0%</h2>
                            <p class="text-sm mt-2 opacity-90" id="today-completed">0/0 个习惯</p>
                        </div>
                        <div class="relative w-20 h-20">
                            <svg class="w-20 h-20 transform -rotate-90">
                                <circle cx="40" cy="40" r="36" stroke="rgba(255,255,255,0.3)" stroke-width="6" fill="none"/>
                                <circle id="progress-circle" cx="40" cy="40" r="36" stroke="white" stroke-width="6" fill="none" 
                                    stroke-dasharray="226" stroke-dashoffset="226" stroke-linecap="round" class="transition-all duration-500"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i class="fas fa-fire text-2xl animate-pulse"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="habits-list" class="space-y-3"></div>

                <div id="empty-state" class="hidden text-center py-12">
                    <div class="w-24 h-24 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-seedling text-4xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-500">还没有习惯，点击右上角添加</p>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="hidden p-4">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </button>
                        <h3 class="font-bold text-lg" id="calendar-month">2024年1月</h3>
                        <button onclick="changeMonth(1)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-xs text-gray-400 py-2">日</div>
                        <div class="text-center text-xs text-gray-400 py-2">一</div>
                        <div class="text-center text-xs text-gray-400 py-2">二</div>
                        <div class="text-center text-xs text-gray-400 py-2">三</div>
                        <div class="text-center text-xs text-gray-400 py-2">四</div>
                        <div class="text-center text-xs text-gray-400 py-2">五</div>
                        <div class="text-center text-xs text-gray-400 py-2">六</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>

                <div id="date-info" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <h4 class="font-bold mb-3" id="selected-date-text">今天</h4>
                    <div id="date-habits" class="space-y-2"></div>
                </div>
            </div>

            <!-- Stats View -->
            <div id="stats-view" class="hidden p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="text-sm text-gray-500">本周完成率</span>
                        </div>
                        <p class="text-2xl font-bold text-gray-800" id="week-rate">0%</p>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <span class="text-sm text-gray-500">本月完成率</span>
                        </div>
                        <p class="text-2xl font-bold text-gray-800" id="month-rate">0%</p>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-orange-400 to-pink-500 rounded-2xl p-6 text-white shadow-lg">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center">
                            <i class="fas fa-fire text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-white/80 text-sm">最长连续打卡</p>
                            <h3 class="text-3xl font-bold" id="max-streak">0 天</h3>
                            <p class="text-sm mt-1 opacity-90" id="max-streak-habit">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-bold mb-4">习惯详情</h3>
                    <div id="stats-list" class="space-y-4"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav glass border-t border-gray-200 px-6 py-3">
            <div class="flex justify-around items-center">
                <button onclick="switchView('today')" class="nav-btn flex flex-col items-center gap-1 p-2 text-indigo-600 min-w-[60px]" data-view="today">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs">今日</span>
                </button>
                <button onclick="switchView('calendar')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 min-w-[60px]" data-view="calendar">
                    <i class="fas fa-calendar-alt text-xl"></i>
                    <span class="text-xs">日历</span>
                </button>
                <button onclick="switchView('stats')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 min-w-[60px]" data-view="stats">
                    <i class="fas fa-chart-pie text-xl"></i>
                    <span class="text-xs">统计</span>
                </button>
            </div>
        </nav>

        <!-- Add Modal -->
        <div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-end justify-center backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">添加新习惯</h2>
                    <button onclick="hideAddModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>

                <form id="add-habit-form" onsubmit="saveHabit(event)">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">习惯名称</label>
                        <input type="text" id="habit-name" required placeholder="例如：早起、阅读、运动..." 
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择图标</label>
                        <div class="grid grid-cols-6 gap-3" id="icon-grid"></div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择颜色</label>
                        <div class="flex gap-3 flex-wrap" id="color-grid"></div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提醒时间（可选）</label>
                        <input type="time" id="habit-time" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 outline-none">
                    </div>

                    <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg active:scale-95 mb-4">
                        创建习惯
                    </button>
                </form>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6">
                <h3 class="text-lg font-bold mb-4">管理习惯</h3>
                <p class="text-gray-600 mb-6" id="edit-habit-name"></p>
                <div class="space-y-3">
                    <button onclick="deleteHabit()" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-medium">删除习惯</button>
                    <button onclick="hideEditModal()" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-medium">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let habits = JSON.parse(localStorage.getItem('habits')) || [];
        let records = JSON.parse(localStorage.getItem('records')) || {};
        let currentView = 'today';
        let currentMonth = new Date();
        let selectedDate = new Date();
        let editingHabitId = null;
        let selectedIcon = 'star';
        let selectedColor = 'indigo';

        const icons = ['star', 'heart', 'bolt', 'moon', 'sun', 'book', 'dumbbell', 'glass-water', 'medal', 'fire', 'leaf', 'music'];
        const colors = [
            { name: 'indigo', class: 'bg-indigo-500', hex: '#6366f1' },
            { name: 'purple', class: 'bg-purple-500', hex: '#8b5cf6' },
            { name: 'pink', class: 'bg-pink-500', hex: '#ec4899' },
            { name: 'red', class: 'bg-red-500', hex: '#ef4444' },
            { name: 'orange', class: 'bg-orange-500', hex: '#f97316' },
            { name: 'amber', class: 'bg-amber-500', hex: '#f59e0b' },
            { name: 'green', class: 'bg-green-500', hex: '#22c55e' },
            { name: 'teal', class: 'bg-teal-500', hex: '#14b8a6' },
            { name: 'blue', class: 'bg-blue-500', hex: '#3b82f6' },
            { name: 'cyan', class: 'bg-cyan-500', hex: '#06b6d4' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            updateDate();
            renderToday();
            initIconGrid();
            initColorGrid();
            setInterval(checkReminders, 60000);
        });

        function updateDate() {
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.view === view) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-indigo-600');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-indigo-600');
                }
            });

            ['today', 'calendar', 'stats'].forEach(v => {
                document.getElementById(v + '-view').classList.add('hidden');
            });
            document.getElementById(view + '-view').classList.remove('hidden');

            if (view === 'today') renderToday();
            if (view === 'calendar') renderCalendar();
            if (view === 'stats') renderStats();
        }

        function renderToday() {
            const list = document.getElementById('habits-list');
            const emptyState = document.getElementById('empty-state');
            const today = new Date().toDateString();
            
            if (habits.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                updateProgress(0, 0);
                return;
            }
            
            emptyState.classList.add('hidden');
            list.innerHTML = '';
            
            let completed = 0;
            habits.forEach(habit => {
                const isChecked = records[habit.id]?.[today];
                if (isChecked) completed++;
                list.appendChild(createHabitCard(habit, isChecked, today));
            });
            
            updateProgress(completed, habits.length);
        }

        function createHabitCard(habit, isChecked, dateStr) {
            const div = document.createElement('div');
            div.className = `habit-card bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center justify-between ${isChecked ? 'opacity-75' : ''}`;
            
            const colorClass = colors.find(c => c.name === habit.color)?.class || 'bg-indigo-500';
            const streak = calculateStreak(habit.id);
            
            div.innerHTML = `
                <div class="flex items-center gap-4 flex-1" onclick="showEditModal('${habit.id}')">
                    <div class="w-12 h-12 rounded-xl ${colorClass} flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-${habit.icon} text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold ${isChecked ? 'line-through text-gray-400' : ''}">${habit.name}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs ${streak > 0 ? 'text-orange-500 font-medium' : 'text-gray-400'}">
                                <i class="fas fa-fire mr-1"></i>${streak} 天连续
                            </span>
                            ${habit.reminder ? `<span class="text-xs text-gray-400"><i class="fas fa-bell mr-1"></i>${habit.reminder}</span>` : ''}
                        </div>
                    </div>
                </div>
                <button onclick="toggleHabit('${habit.id}', event)" 
                    class="w-12 h-12 rounded-full flex items-center justify-center text-2xl transition-all ${isChecked ? 'bg-green-500 text-white scale-110' : 'bg-gray-100 text-gray-300'}">
                    <i class="fas fa-check"></i>
                </button>
            `;
            return div;
        }

        function updateProgress(completed, total) {
            const percentage = total === 0 ? 0 : Math.round((completed / total) * 100);
            document.getElementById('today-progress').textContent = percentage + '%';
            document.getElementById('today-completed').textContent = `${completed}/${total} 个习惯`;
            
            const circle = document.getElementById('progress-circle');
            const offset = 226 - (percentage / 100) * 226;
            circle.style.strokeDashoffset = offset;
        }

        function toggleHabit(id, event) {
            event.stopPropagation();
            const today = new Date().toDateString();
            if (!records[id]) records[id] = {};
            
            if (records[id][today]) {
                delete records[id][today];
            } else {
                records[id][today] = true;
                createConfetti();
            }
            
            localStorage.setItem('records', JSON.stringify(records));
            renderToday();
        }

        function calculateStreak(habitId) {
            const dates = Object.keys(records[habitId] || {}).sort();
            if (dates.length === 0) return 0;
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayStr = today.toDateString();
            if (records[habitId]?.[todayStr]) streak = 1;
            
            let checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - 1);
            
            while (records[habitId]?.[checkDate.toDateString()]) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            }
            return streak;
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            document.getElementById('calendar-month').textContent = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toDateString();
                const isToday = dateStr === today.toDateString();
                
                let checkedCount = 0;
                habits.forEach(h => { if (records[h.id]?.[dateStr]) checkedCount++; });
                
                const cell = document.createElement('div');
                cell.className = `calendar-day cursor-pointer hover:bg-gray-100 ${isToday ? 'today' : ''} ${checkedCount > 0 ? 'active' : ''}`;
                cell.textContent = day;
                cell.onclick = () => selectDate(date);
                grid.appendChild(cell);
            }
            selectDate(selectedDate);
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function selectDate(date) {
            selectedDate = date;
            const dateStr = date.toDateString();
            const isToday = dateStr === new Date().toDateString();
            
            document.getElementById('selected-date-text').textContent = 
                isToday ? '今天' : date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            
            const container = document.getElementById('date-habits');
            container.innerHTML = '';
            
            if (habits.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">没有习惯</p>';
                return;
            }
            
            habits.forEach(habit => {
                const isChecked = records[habit.id]?.[dateStr];
                const colorClass = colors.find(c => c.name === habit.color)?.class || 'bg-indigo-500';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-xl';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${colorClass} flex items-center justify-center text-white">
                            <i class="fas fa-${habit.icon} text-sm"></i>
                        </div>
                        <span class="font-medium ${isChecked ? 'line-through text-gray-400' : ''}">${habit.name}</span>
                    </div>
                    ${isChecked ? '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : '<i class="fas fa-circle text-gray-200 text-xl"></i>'}
                `;
                container.appendChild(item);
            });
        }

        function renderStats() {
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            let weekTotal = 0, weekChecked = 0;
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                const ds = d.toDateString();
                habits.forEach(h => {
                    weekTotal++;
                    if (records[h.id]?.[ds]) weekChecked++;
                });
            }
            document.getElementById('week-rate').textContent = weekTotal === 0 ? '0%' : Math.round((weekChecked / weekTotal) * 100) + '%';
            
            const monthStart = new Date();
            monthStart.setDate(1);
            const daysInMonth = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0).getDate();
            let monthTotal = 0, monthChecked = 0;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(monthStart.getFullYear(), monthStart.getMonth(), i);
                const ds = d.toDateString();
                habits.forEach(h => {
                    monthTotal++;
                    if (records[h.id]?.[ds]) monthChecked++;
                });
            }
            document.getElementById('month-rate').textContent = monthTotal === 0 ? '0%' : Math.round((monthChecked / monthTotal) * 100) + '%';
            
            let maxStreak = 0, maxStreakHabit = null;
            habits.forEach(habit => {
                const streak = calculateStreak(habit.id);
                if (streak > maxStreak) {
                    maxStreak = streak;
                    maxStreakHabit = habit;
                }
            });
            
            document.getElementById('max-streak').textContent = maxStreak + ' 天';
            document.getElementById('max-streak-habit').textContent = maxStreakHabit?.name || '-';
            
            const list = document.getElementById('stats-list');
            list.innerHTML = '';
            habits.forEach(habit => {
                const totalDays = Object.keys(records[habit.id] || {}).length;
                const streak = calculateStreak(habit.id);
                const colorClass = colors.find(c => c.name === habit.color)?.class || 'bg-indigo-500';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 border-b border-gray-100 last:border-0';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg ${colorClass} flex items-center justify-center text-white">
                            <i class="fas fa-${habit.icon}"></i>
                        </div>
                        <div>
                            <p class="font-medium">${habit.name}</p>
                            <p class="text-xs text-gray-400">累计打卡 ${totalDays} 天</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-orange-500">${streak}</p>
                        <p class="text-xs text-gray-400">连续天数</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('add-modal').classList.add('flex');
            document.getElementById('habit-name').value = '';
            document.getElementById('habit-time').value = '';
            selectedIcon = 'star';
            selectedColor = 'indigo';
            updateSelectionUI();
        }

        function hideAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('add-modal').classList.remove('flex');
        }

        function initIconGrid() {
            const grid = document.getElementById('icon-grid');
            icons.forEach((icon, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `icon-option w-10 h-10 rounded-xl flex items-center justify-center text-gray-600 bg-gray-100 ${icon === selectedIcon ? 'selected' : ''}`;
                btn.innerHTML = `<i class="fas fa-${icon}"></i>`;
                btn.onclick = () => { selectedIcon = icon; updateSelectionUI(); };
                grid.appendChild(btn);
            });
        }

        function initColorGrid() {
            const grid = document.getElementById('color-grid');
            colors.forEach((color, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `color-option w-10 h-10 rounded-full ${color.class} ${color.name === selectedColor ? 'selected' : ''}`;
                btn.onclick = () => { selectedColor = color.name; updateSelectionUI(); };
                grid.appendChild(btn);
            });
        }

        function updateSelectionUI() {
            document.querySelectorAll('.icon-option').forEach((btn, idx) => {
                btn.classList.toggle('selected', icons[idx] === selectedIcon);
            });
            document.querySelectorAll('.color-option').forEach((btn, idx) => {
                btn.classList.toggle('selected', colors[idx].name === selectedColor);
            });
        }

        function saveHabit(e) {
            e.preventDefault();
            const name = document.getElementById('habit-name').value.trim();
            const time = document.getElementById('habit-time').value;
            if (!name) return;
            
            habits.push({
                id: Date.now().toString(),
                name,
                icon: selectedIcon,
                color: selectedColor,
                reminder: time,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem('habits', JSON.stringify(habits));
            hideAddModal();
            renderToday();
        }

        function showEditModal(id) {
            editingHabitId = id;
            const habit = habits.find(h => h.id === id);
            if (!habit) return;
            document.getElementById('edit-habit-name').textContent = habit.name;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
            editingHabitId = null;
        }

        function deleteHabit() {
            if (!editingHabitId) return;
            if (!confirm('确定要删除这个习惯吗？')) return;
            
            habits = habits.filter(h => h.id !== editingHabitId);
            delete records[editingHabitId];
            localStorage.setItem('habits', JSON.stringify(habits));
            localStorage.setItem('records', JSON.stringify(records));
            renderToday();
            hideEditModal();
        }

        function checkReminders() {
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            habits.forEach(habit => {
                if (habit.reminder === timeStr && Notification.permission === 'granted') {
                    new Notification('习惯打卡', { body: `该完成"${habit.name}"了！` });
                }
            });
        }

        function createConfetti() {
            const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#22c55e'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        document.getElementById('add-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) hideAddModal();
        });
        
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) hideEditModal();
        });
    </script>
</body>
</html>